name: Build and Run Tests

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  run-tests:
    name: 'Build'
    runs-on: ubuntu-22.04
    container: explyt/tsa-env:v1.1.3

    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
        with:
          submodules: recursive

#        We don't need to setup Java because it is manually installed in the Docker image
#      - uses: actions/setup-java@v4
#        with:
#          distribution: 'temurin'
#          java-version: '17'
#          cache: 'gradle'

      - name: 'Assemble'
        run: ./gradlew clean assemble

      - name: Get commit hash
        id: get-commit
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: 'Create draft release'
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          name: "Build ${{ steps.get-commit.outputs.sha_short }}"
          body: "Automated release for commit ${{ steps.get-commit.outputs.sha_short }}"
          files: |
            **/build/libs/tsa-cli.jar

